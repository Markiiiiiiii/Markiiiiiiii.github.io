{"meta":{"title":"老菜的菜单","subtitle":"记录点技术点滴","description":"","author":"Liuuuuuuuuu","url":"http://markiiiiiiii.github.io","root":"/"},"pages":[{"title":"分类","date":"2020-08-03T03:52:25.000Z","updated":"2020-08-03T03:56:00.368Z","comments":true,"path":"categories/index.html","permalink":"http://markiiiiiiii.github.io/categories/index.html","excerpt":"","text":""},{"title":"tags","date":"2020-08-03T03:56:56.000Z","updated":"2020-08-03T03:57:14.411Z","comments":true,"path":"tags/index.html","permalink":"http://markiiiiiiii.github.io/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"Ubuntu中配置Mail命令使用外部STMP发送邮件","slug":"Ubuntu中配置Mail命令使用外部STMP发送邮件","date":"2020-08-17T04:15:43.000Z","updated":"2020-08-17T04:37:03.645Z","comments":true,"path":"2020/08/17/Ubuntu中配置Mail命令使用外部STMP发送邮件/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/17/Ubuntu%E4%B8%AD%E9%85%8D%E7%BD%AEMail%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8STMP%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/","excerpt":"","text":"Ubuntu中配置mail命令使用外部的stmp发送邮件因为在日常运维过程中我们需要使用mail命令，实时的发送服务器的一些状态参数或者监控服务器的运行状态，所以在mail的日常应用中还是非常的高频，鉴于我们做的站点大部分不开启自己本身的邮箱服务所以我们还是尽量使用外部的stmp邮箱服务来完成我们这个发信过程。 ！！！注意！！！Ubuntu于其他发行版的不同，需要注意安装mail命令和相关软件包时的几个坑 1.安装heirloom-mailx mailutils需要将 1deb http:&#x2F;&#x2F;cz.archive.ubuntu.com&#x2F;ubuntu xenial main universe 添加到/etc/apt/sources.list中并执行apt-get update后再apt install heirloom-mailx mailutils 因为heirloom-mailx并不在官方的源内。 2.修改配置文件 /etc/s-nail.rc添加如下配置 12345set from&#x3D;xxx@xxx.com #设置发送邮箱set smtp&#x3D;smtps:&#x2F;&#x2F;smtp.xxx.com #设置smtp服务器和端口set smtp-auth-user&#x3D;cm@xxx.com #设置用户名，记得加域名啊set smtp-auth-password&#x3D;xxxxx #邮箱授权码set smtp-auth&#x3D;xxx@xxx.com #用户名 3.修改服务器的主机名称12$&gt; hostnamexxxxx 一般VPS的名称大部分为一个无序字符串组成，这个字符串在发信时会不符合目的邮件服务器的要求一般会出现550错误，126会出现以下的： 1&lt;&lt;&lt; 550 MI:IMF 126 mx2,IMmowACXz0un8TlfJMPIAg--.47921S3 1597632936 http:&#x2F;&#x2F;mail.163.com&#x2F;help&#x2F;help_spam_16.htm?ip&#x3D;173.82.56.165&amp;hostid&#x3D;mx2&amp;time&#x3D;1597632936 google也是会出现类似的550错误，这个错误是因为我们的主机名不符合邮件服务器的要求，将你的主机名修改xxx.com类似的形式即可发信成功 12hostname xxx.xxx.com#临时修改主机名，重启后恢复原字符串主机名 或者可以 12vim &#x2F;etc&#x2F;hostname#永久修改为xxx.xxx.com 注意需reboot重启。 4.注意尽量使用邮箱给的授权码，不要使用邮箱的登录码","categories":[{"name":"运维","slug":"运维","permalink":"http://markiiiiiiii.github.io/categories/%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"Ubuntu","slug":"Ubuntu","permalink":"http://markiiiiiiii.github.io/tags/Ubuntu/"},{"name":"Linux","slug":"Linux","permalink":"http://markiiiiiiii.github.io/tags/Linux/"}]},{"title":"MySQL8.0x的主从同步设置","slug":"mysql8.0.x的主从同步设置","date":"2020-08-14T02:47:37.000Z","updated":"2020-08-14T06:31:52.376Z","comments":true,"path":"2020/08/14/mysql8.0.x的主从同步设置/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/14/mysql8.0.x%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E8%AE%BE%E7%BD%AE/","excerpt":"","text":"手动导出主数据库sql文件导入到从数据库中保持数据和表结构的一致性。 1mysqldump -t 数据库名 -uroot -p &gt; xxx.sql 主数据库 12345678mysql&gt;create user &#39;syncdata&#39;@&#39;localhost&#39; identified by &#39;1234567&#39;;mysql&gt;grant replication slave on *.* to &#39;syncdata&#39;@&#39;127.0.0.1&#39;;mysql&gt; show master status;+------------------+----------+--------------+------------------+-------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+-------------------+| mysql-bin.000001 | 1454 | | | |+------------------+----------+--------------+------------------+-------------------+ 从数据库 12mysql --ssl-mode&#x3D;DISABLED -h172.17.0.2 -uroot -p123456 --get-server-public-key#先获取主数据库秘钥，因为mysql修改了验证方式，不然会报错。 12mysql&gt; change master to master_host&#x3D;&#39;ip&#39;, master_port&#x3D;16123, master_user&#x3D;&#39;syncdata&#39;,master_password&#x3D;&#39;1234567&#39;,master_log_file&#x3D;&#39;mysql-bin.000001&#39;;mysql&gt; show slave status\\G; #查看从数据库状态 指定数据库同步 12从服务器mysql&gt; change replication filter replicate_do_db&#x3D;(base_name);","categories":[],"tags":[]},{"title":"Nginx针对Wordpress做动静分离","slug":"Nginx针对Wordpress做动静分离","date":"2020-08-13T04:32:21.000Z","updated":"2020-08-13T04:52:40.968Z","comments":true,"path":"2020/08/13/Nginx针对Wordpress做动静分离/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/13/Nginx%E9%92%88%E5%AF%B9Wordpress%E5%81%9A%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/","excerpt":"","text":"nginx 作高性能反向代理服务器nginx作为高性能的web服务器常常用于各种的反向代理和负载均衡服务器，但是今天遇到一个小小的问题为wordpress做一个动静分离需求。 首先发现这个wordpress使用的url传参并不是使用的访问某个.php页面提交参数，而是直接将参数传给根域名 1http:&#x2F;&#x2F;192.168.1.1&#x2F;?s&#x3D;xxx 如果传统的简单访问某个动态语言编写的页面nginx是非常简单直接写一个类似： 123location ~ *\\.php $ &#123; proxy_pass http:&#x2F;&#x2F;server_group; &#125; 就可以将参数传递给了动态服务器。 但是基于这个wordpress的需求我们需要将这么写 12345678 location &#x2F; &#123; index index.html index.htm; proxy_pass http:&#x2F;&#x2F;html_server_group; if ($query_string ~* &quot;s&#x3D;(.*)$&quot;)&#123; proxy_pass http:&#x2F;&#x2F;server_group; &#125; &#125;#这里$query_string是传参字符串，s是wp系统中指定的传参变量，（.*）正则表示接受后面所有的字符串，如果多个变量以此类推。 这里我们因为实验环境，使用了ngrok把内网服务器映射到了公网，但是我们的nginx代理服务器在google vps上，这时需要在nginx中使用dns解析内网域名。 首先在conf中写入dns解析服务器 1resolver 8.8.8.8; #使用google的dns解析域名 然后写location /为： 12345678location &#x2F; &#123; index index.html index.htm; proxy_pass http:&#x2F;&#x2F;html_server_group; set $serverin e338a4fb64e2.ngrok.io; #定义serverin变量为映射域名 if ($query_string ~* &quot;s&#x3D;(.*)$&quot;)&#123; proxy_pass http:&#x2F;&#x2F;$serverin; &#125; &#125; 测试通过","categories":[{"name":"运维","slug":"运维","permalink":"http://markiiiiiiii.github.io/categories/%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"http://markiiiiiiii.github.io/tags/nginx/"},{"name":"wordpress","slug":"wordpress","permalink":"http://markiiiiiiii.github.io/tags/wordpress/"}]},{"title":"Google虚拟机vps的本地化SSH登陆设置","slug":"Google虚拟机vps的本地化SSH登陆设置","date":"2020-08-11T00:50:51.000Z","updated":"2020-08-11T01:00:06.468Z","comments":true,"path":"2020/08/11/Google虚拟机vps的本地化SSH登陆设置/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/11/Google%E8%99%9A%E6%8B%9F%E6%9C%BAvps%E7%9A%84%E6%9C%AC%E5%9C%B0%E5%8C%96SSH%E7%99%BB%E9%99%86%E8%AE%BE%E7%BD%AE/","excerpt":"","text":"Google cloud VPS 本地使用SSH登陆昨天发现google cloud上发现还有2K+的余额，正好最近在学习nginx的负载平衡，拿来做个vps来做nginx的服务器来实例化一下。vps做好后结果发现本地ssh登陆是要做一些小小的设置。 1234ssh-keygen -f googlekey #创建一个googlekey公私钥cat googlekey.pub#输出公钥 打开google cloud的元数据–ssh–修改–添加一项 将公钥输入保存 本地终端中输入： 12ssh -i googlekey username@ip#username这时是在元数据中显示的name","categories":[{"name":"运维","slug":"运维","permalink":"http://markiiiiiiii.github.io/categories/%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"Google","slug":"Google","permalink":"http://markiiiiiiii.github.io/tags/Google/"},{"name":"VPS","slug":"VPS","permalink":"http://markiiiiiiii.github.io/tags/VPS/"}]},{"title":"Pyspider+python-Wordpress-xmlrpc爬取自动发布","slug":"Pyspider-python-Wordpress-xmlrpc爬取自动发布","date":"2020-08-08T03:06:40.000Z","updated":"2020-08-08T03:11:58.806Z","comments":true,"path":"2020/08/08/Pyspider-python-Wordpress-xmlrpc爬取自动发布/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/08/Pyspider-python-Wordpress-xmlrpc%E7%88%AC%E5%8F%96%E8%87%AA%E5%8A%A8%E5%8F%91%E5%B8%83/","excerpt":"","text":"Pyspider+python-wordpress-xmlrpc 爬取站点自动发布Pyspider内代码： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117#!&#x2F;usr&#x2F;bin&#x2F;env python# -*- encoding: utf-8 -*-# Created on 2020-08-07 01:19:41# Project: xxxxxxfrom pyspider.libs.base_handler import *import reDIR_PATH &#x3D; &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;mystaticsite&#x2F;downimages&#x2F;&#39;#coding:utf-8from wordpress_xmlrpc import Client, WordPressPostfrom wordpress_xmlrpc.methods.posts import GetPosts, NewPostfrom wordpress_xmlrpc.methods.users import GetUserInfofrom wordpress_xmlrpc.methods import postsfrom wordpress_xmlrpc.methods import taxonomiesfrom wordpress_xmlrpc import WordPressTermfrom wordpress_xmlrpc.compat import xmlrpc_clientfrom wordpress_xmlrpc.methods import media, posts#import importlib#importlib.reload(sys)#sys.setdefaultencoding(&#39;utf-8&#39;) #python3下不支持该用法class Handler(BaseHandler): crawl_config &#x3D; &#123; &#125; def __init__(self):#继承Deal类 self.deal &#x3D; Deal() @every(minutes&#x3D;24 * 60) def on_start(self): self.crawl(&#39;https:&#x2F;&#x2F;www.xxxxxx.com&#x2F;news&#x2F;index.html&#39;, callback&#x3D;self.index_page) @config(age&#x3D;10 * 24 * 60 * 60) def index_page(self, response): for each in response.doc(&#39;h3 &gt; a&#39;).items(): self.crawl(each.attr.href, callback&#x3D;self.detail_page) @config(priority&#x3D;2) def detail_page(self, response): title &#x3D; response.doc(&#39;h1&#39;).text(), tmp_text &#x3D; response.doc(&#39;.loadimg.fadeInUp &gt; p&#39;).text(), tmp_text &#x3D; &#39;&#39;.join(str(tmp_text)) #将元组数据转换为字符串 tmp_text &#x3D; tmp_text.replace(&quot;下面我们一起来看看她最新的番号作品吧！&quot;,&quot;&quot;) new_text &#x3D; tmp_text.replace(&quot;(&#39; &quot;,&quot;&quot;)#清洗掉原文中的标记 for each in response.doc(&#39;.loadimg.fadeInUp &gt; p &gt; img&#39;).items(): img_url &#x3D; each.attr.src if (&quot;xxxxxx&quot; in img_url): #过滤掉不在xxxxxx站点上的图片连接 split_url &#x3D; img_url.split(&#39;&#x2F;&#39;) dir_name &#x3D; split_url[-2] + &#39;&#x2F;&#39; dir_path &#x3D; self.deal.mkDir(dir_name) file_name &#x3D; split_url[-1] relativpath &#x3D; &#39;&lt;img src&#x3D;&quot;&#x2F;downimages&#x2F;&#39; + dir_name + file_name + &#39;&quot;&gt;&lt;br&gt;&#39;#构建图片显示的相对路径 new_text &#x3D; relativpath + new_text #将图片插入文章头部 self.crawl(img_url,callback&#x3D;self.save_img, save&#x3D;&#123;&#39;dir_path&#39;:dir_path ,&#39;file_name&#39;:file_name&#125;) title &#x3D; &#39;&#39;.join(str(title)) title &#x3D; title.replace(&quot;(&#39;&quot;,&quot;&quot;) title &#x3D; title.replace(&quot;&#39;,)&quot;,&quot;&quot;) wp &#x3D; Client(&#39;http:&#x2F;&#x2F;server&#x2F;xmlrpc.php&#39;, &#39;username&#39;, &#39;password&#39;) post &#x3D; WordPressPost() post.title &#x3D; title post.content &#x3D; new_text post.post_status &#x3D; &#39;publish&#39; post.id &#x3D; wp.call(posts.NewPost(post)) #print(&quot;爬取注入:&quot;+ post.id + &quot;post.title&quot;) def save_img(self,response): #保存图片 content &#x3D; response.content dir_path &#x3D; response.save[&#39;dir_path&#39;] file_name &#x3D; response.save[&#39;file_name&#39;] file_path &#x3D; dir_path + &#39;&#x2F;&#39; + file_name self.deal.saveImg(content,file_path) import osclass Deal: def __init__(self): self.path &#x3D; DIR_PATH if not self.path.endswith(&#39;&#x2F;&#39;): self.path &#x3D; self.path + &#39;&#x2F;&#39; if not os.path.exists(self.path): os.makedirs(self.path) def mkDir(self, path): path &#x3D; path.strip() dir_path &#x3D; self.path + path exists &#x3D; os.path.exists(dir_path) if not exists: os.makedirs(dir_path) return dir_path else: return dir_path def saveImg(self, content, path): f &#x3D; open(path, &#39;wb&#39;) f.write(content) f.close() def saveBrief(self, content, dir_path, name): file_name &#x3D; dir_path + &quot;&#x2F;&quot; + name + &quot;.txt&quot; f &#x3D; open(file_name, &quot;w+&quot;) f.write(content.encode(&#39;utf-8&#39;)) def getExtension(self, url): extension &#x3D; url.split(&#39;.&#39;)[-1] return extension# return &#123;# &quot;title&quot;: title,# &quot;contenttext&quot;: contenttext,# # &#125;","categories":[{"name":"编程","slug":"编程","permalink":"http://markiiiiiiii.github.io/categories/%E7%BC%96%E7%A8%8B/"}],"tags":[{"name":"wordpress","slug":"wordpress","permalink":"http://markiiiiiiii.github.io/tags/wordpress/"},{"name":"pyspider","slug":"pyspider","permalink":"http://markiiiiiiii.github.io/tags/pyspider/"}]},{"title":"高负载web站点设计 (一)","slug":"高负载web站点设计","date":"2020-08-05T06:08:38.000Z","updated":"2020-08-05T06:28:04.636Z","comments":true,"path":"2020/08/05/高负载web站点设计/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/05/%E9%AB%98%E8%B4%9F%E8%BD%BDweb%E7%AB%99%E7%82%B9%E8%AE%BE%E8%AE%A1/","excerpt":"","text":"A.负载平衡服务器 A.1. ngnix反向代理服务根据B服务组的最短时间或负载来自动均衡。 B.静态页面服务器集群b.1. nginx WEB业务集群 使用rsync服务同步C.1.服务器生成的静态页面和相关的静态资源。（扩展思路：将GIF，JPG等静态资源单独使用dfs服务器分流） C.内网动态服务器c.1. Wordpress内容生产服务器 wordpress服务器使用wp2static插件生成静态页面，wp2static插件可以识别之前生成的页面从而减少服务器负载。 wordpress服务器使用inonifywait脚本监控wp2static插件生成的静态页面目录，如果产生文件的变更（创建、删除、修改、移动）和目录结构的变更后，则通过rsync服务器同步远程服务器。 c.2. Pyspider爬虫服务器 Pyspider爬虫框架爬取需要的数据 安装python-wordpress-xmlrpc库， 使用wordpress的rpc服务接受Pyspider爬取经过清洗后的数据发布到wordpress服务器。","categories":[{"name":"运维","slug":"运维","permalink":"http://markiiiiiiii.github.io/categories/%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"http://markiiiiiiii.github.io/tags/nginx/"},{"name":"Ubuntu","slug":"Ubuntu","permalink":"http://markiiiiiiii.github.io/tags/Ubuntu/"}]},{"title":"rsync+inofity内网向外网同步数据(一)","slug":"rsync-inofity内网向外网同步数据","date":"2020-08-03T03:22:53.000Z","updated":"2020-08-12T06:41:33.171Z","comments":true,"path":"2020/08/03/rsync-inofity内网向外网同步数据/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/03/rsync-inofity%E5%86%85%E7%BD%91%E5%90%91%E5%A4%96%E7%BD%91%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/","excerpt":"","text":"设计要求 内网web服务器生成html页面 内网向外网同步生成的html页面和目录 外网服务器纯静态资源访问 系统环境 内网 Ubuntu 20.x + Ngnix + PHP + Mysql + Wordpress 外网 Ubuntu 20.x + Ngnix 外网服务器配置外网服务器必须提供rsync –daemon服务以监听内网服务器发出的同步指令 12345678910111213141516171819202122232425[123] comment &#x3D; 123 static html files server path &#x3D; &#x2F;var&#x2F;www&#x2F;staichtml&#x2F; use chroot &#x3D; no max connections&#x3D;20 lock file &#x3D; &#x2F;var&#x2F;lock&#x2F;rsyncd read only &#x3D; no write only &#x3D; no list &#x3D; yes uid &#x3D; rsync gid &#x3D; rsync auth users &#x3D; rsync_clint secrets file &#x3D; &#x2F;etc&#x2F;rsyncd.secrets strict modes &#x3D; yes port&#x3D;873 pid file &#x3D; &#x2F;var&#x2F;run&#x2F;rsyncd.pid log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log log format &#x3D; %t %a %m %f %b ignore errors &#x3D; yes ignore nonreadable &#x3D; yes transfer logging &#x3D; yes timeout &#x3D; 600 refuse options &#x3D; checksum dry-run dont compress &#x3D; *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz 创建 /etc/rsyncd.secrets 并 chmod 600 权限 1rsync_clint:密码123 添加一个系统用户为rsync的用户 该用户不具备登录权限 &lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;useradd -s &amp;#x2F;sbin&amp;#x2F;nologin -M rsync&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt; ！！！注意！！！必须 chmod 777 /var/www/staichtml/ 在实际操作中发现没有x权限rsync服务无法写入文件 内网服务器配置略过相关web服务配置创建 /etc/rsyncd.secrets 并 chmod 600 权限，仅存放密码使用 1密码123 安装apt install inofity-tool 编写简单实现的.sh文件并 chmod +x xxxx.sh 12345678910##测试代码：#!&#x2F;bin&#x2F;bashsrc&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;mystaticsite&#x2F; #同步目录路径ip&#x3D;111.111.111.111&#x2F;usr&#x2F;bin&#x2F;inotifywait -rm --timefmt &#39;%d&#x2F;%m&#x2F;%y %H:%M&#39; --format &#39;%T %w%f%e&#39; -e modify,delete,create,attrib,move $src | while read file do rsync -avz --delete --progress $src rsync_clint@$ip::123 --password-file&#x3D;&#x2F;etc&#x2F;rsyncd.secrets echo &quot;$&#123;file&#125; was rsynced&quot; &gt;&gt; &#x2F;tmp&#x2F;rsync.log 2&gt;&amp;1 done 123！！！注意！！！必须将$src的位置写在连接之前不能放在连接之后，不然外网服务器无法接受到文件。这一点与网上很多教程向左，卡了我两天多的时间才发现的:( 生产环境代码：123456789101112131415161718192021222324252627282930313233343536373839404142#!&#x2F;bin&#x2F;bashsrc&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F; #同步目录路径user&#x3D;rsync_clintip1&#x3D;7xx.xxx.xxx.xxxip2&#x3D;1xx.xx.xxx.xxdes&#x3D;123pswfile&#x3D;&#x2F;etc&#x2F;rsyncd.secretscd $&#123;src&#125;&#x2F;usr&#x2F;bin&#x2F;inotifywait -rmq --format &#39;%Xe %w%f&#39; -e modify,delete,create,attrib,close_write,move .&#x2F; | while read file do INO_EVENT&#x3D;$(echo $file | awk&#39;&#123;print $1&#125;&#39;) INO_FILE&#x3D;$(echo $file | awk&#39;&#123;print $2&#125;&#39;) echo &quot;----------------$&#123;data&#125;-----------------&quot; echo $file if [[$INO_EVENT &#x3D;~ &#39;CREATE&#39;]] || [[$INO_EVENT &#x3D;~ &#39;MODIFY&#39;]] || [[$INO_EVENT &#x3D;~ &#39;CLOSE_WRITE&#39;]] || [[$INO_EVENT &#x3D;~ &#39;MOVE_TO&#39;]] then echo &#39;Creat or Modify or Close_write or Moved_to&#39; rsync -avzcR --password-file&#x3D;$&#123;pswfile&#125; $(dirname $&#123;INO_FILE&#125;) $&#123;user&#125;@$ip&#123;1&#125;::$&#123;des&#125; &amp;&amp; rsync -avzcR --password-file&#x3D;$&#123;pswfile&#125; $(dirname $&#123;INO_FILE&#125;) $&#123;user&#125;@$ip&#123;2&#125;::$&#123;des&#125; fi if [[$INO_EVENT &#x3D;~ &#39;DELETE&#39;]] || [[$INO_EVENT &#x3D;~ &#39;MOVE_FROM&#39;]] then echo &#39;Delete or Moved_from&#39; rsync -avzR --delete --password-file&#x3D;$&#123;pswfile&#125; $(dirname $&#123;INO_FILE&#125;) $&#123;user&#125;@$ip&#123;1&#125;::$&#123;des&#125; &amp;&amp; rsync -avzR --delete --password-file&#x3D;$&#123;pswfile&#125; $(dirname $&#123;INO_FILE&#125;) $&#123;user&#125;@$ip&#123;2&#125;::$&#123;des&#125; fi if [[$INO_EVENT &#x3D;~ &#39;ATTRIB&#39;]] then echo &#39;Attrib&#39; if [ !-d &quot;$INO_FILE&quot; ] then rsync -avzcR --password-file&#x3D;$&#123;pswfile&#125; $(dirname $&#123;INO_FILE&#125;) $&#123;user&#125;@$ip&#123;1&#125;::$&#123;des&#125; &amp;&amp; rsync -avzcR --password-file&#x3D;$&#123;pswfile&#125; $(dirname $&#123;INO_FILE&#125;) $&#123;user&#125;@$ip&#123;2&#125;::$&#123;des&#125; fi fi done 因为inotify不会监控到为启动时的变化，所以直接在crontab里增加一个2小时全量目录同步 123crontab -e* *&#x2F;2 * * * rsync -avz --password-file&#x3D;&#x2F;etc&#x2F;rsyncd.secrets&#x2F;var&#x2F;www&#x2F;html&#x2F; rsync_clint@1xxx.xxx.xxx.xxx::123 &amp;&amp; rsync -avz --password-file&#x3D;&#x2F;etc&#x2F;rsyncd.secrets &#x2F;var&#x2F;www&#x2F;html&#x2F; rrsync_clint@7xx.xxx.xxx.xx::123","categories":[{"name":"运维","slug":"运维","permalink":"http://markiiiiiiii.github.io/categories/%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"Ubuntu","slug":"Ubuntu","permalink":"http://markiiiiiiii.github.io/tags/Ubuntu/"},{"name":"rsync","slug":"rsync","permalink":"http://markiiiiiiii.github.io/tags/rsync/"},{"name":"inotify","slug":"inotify","permalink":"http://markiiiiiiii.github.io/tags/inotify/"}]},{"title":"rsync同步基本配置（基础知识）","slug":"rsync同步基本配置（基础知识）","date":"2020-08-03T02:04:38.000Z","updated":"2020-08-03T03:58:21.709Z","comments":true,"path":"2020/08/03/rsync同步基本配置（基础知识）/","link":"","permalink":"http://markiiiiiiii.github.io/2020/08/03/rsync%E5%90%8C%E6%AD%A5%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%EF%BC%88%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%89/","excerpt":"","text":"rrsync同步基本配置（基础知识）Ubuntu 20.x 环境服务器端：1234567891011121314151617181920[123] comment &#x3D; 123 static html files serverpath &#x3D; &#x2F;var&#x2F;www&#x2F;html&#x2F;siteuse chroot &#x3D; nomax connections&#x3D;20lock file &#x3D; &#x2F;var&#x2F;lock&#x2F;rsyncdread only &#x3D; yeslist &#x3D; yesuid &#x3D; 0gid &#x3D; 0 auth users &#x3D; 123clint secrets file &#x3D; &#x2F;etc&#x2F;rsyncd.secrets strict modes &#x3D; yes port&#x3D;873ignore errors &#x3D; yesignore nonreadable &#x3D; yestransfer logging &#x3D; yestimeout &#x3D; 600refuse options &#x3D; checksum dry-rundont compress &#x3D; *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz 增加/etc/rsyncd.secrets文件 1123clint：密码123456 启动服务器： 1&#x2F;etc&#x2F;init.d&#x2F;rsync --daemon 客户端：增加/etc/rsyncd.secrets文件 1密码123456 客户端连接服务器命令 1rsync -vzrtopg --delete --progress 123clint@服务器地址::123 &#x2F;var&#x2F;www&#x2F;staichtml（客户端备份目录位置） --password-file&#x3D;&#x2F;etc&#x2F;rsyncd.secrets 注意客户端和服务器端的rsyncd.secrets 文件均需要chmod 600 权限 1chmod 600 rsyncd.secrets","categories":[{"name":"运维","slug":"运维","permalink":"http://markiiiiiiii.github.io/categories/%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"Ubuntu","slug":"Ubuntu","permalink":"http://markiiiiiiii.github.io/tags/Ubuntu/"},{"name":"rsync","slug":"rsync","permalink":"http://markiiiiiiii.github.io/tags/rsync/"}]}],"categories":[{"name":"运维","slug":"运维","permalink":"http://markiiiiiiii.github.io/categories/%E8%BF%90%E7%BB%B4/"},{"name":"编程","slug":"编程","permalink":"http://markiiiiiiii.github.io/categories/%E7%BC%96%E7%A8%8B/"}],"tags":[{"name":"Ubuntu","slug":"Ubuntu","permalink":"http://markiiiiiiii.github.io/tags/Ubuntu/"},{"name":"Linux","slug":"Linux","permalink":"http://markiiiiiiii.github.io/tags/Linux/"},{"name":"nginx","slug":"nginx","permalink":"http://markiiiiiiii.github.io/tags/nginx/"},{"name":"wordpress","slug":"wordpress","permalink":"http://markiiiiiiii.github.io/tags/wordpress/"},{"name":"Google","slug":"Google","permalink":"http://markiiiiiiii.github.io/tags/Google/"},{"name":"VPS","slug":"VPS","permalink":"http://markiiiiiiii.github.io/tags/VPS/"},{"name":"pyspider","slug":"pyspider","permalink":"http://markiiiiiiii.github.io/tags/pyspider/"},{"name":"rsync","slug":"rsync","permalink":"http://markiiiiiiii.github.io/tags/rsync/"},{"name":"inotify","slug":"inotify","permalink":"http://markiiiiiiii.github.io/tags/inotify/"}]}