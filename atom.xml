<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>老菜的菜单</title>
  
  <subtitle>记录点技术点滴</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-08-03T03:45:57.762Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Liuuuuuuuuu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>rsync+inofity内网向外网同步数据</title>
    <link href="http://yoursite.com/2020/08/03/rsync-inofity%E5%86%85%E7%BD%91%E5%90%91%E5%A4%96%E7%BD%91%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/"/>
    <id>http://yoursite.com/2020/08/03/rsync-inofity%E5%86%85%E7%BD%91%E5%90%91%E5%A4%96%E7%BD%91%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/</id>
    <published>2020-08-03T03:22:53.000Z</published>
    <updated>2020-08-03T03:45:57.762Z</updated>
    
    <content type="html"><![CDATA[<h2 id="设计要求"><a href="#设计要求" class="headerlink" title="设计要求"></a>设计要求</h2><ul><li>内网web服务器生成html页面</li><li>内网向外网同步生成的html页面和目录</li><li>外网服务器纯静态资源访问</li></ul><h2 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h2><ul><li>内网 Ubuntu 20.x + Ngnix + PHP + Mysql + Wordpress</li><li>外网 Ubuntu 20.x + Ngnix </li></ul><h3 id="外网服务器配置"><a href="#外网服务器配置" class="headerlink" title="外网服务器配置"></a>外网服务器配置</h3><p>外网服务器必须提供rsync –daemon服务以监听内网服务器发出的同步指令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[123]</span><br><span class="line">  comment &#x3D; 123 static html files server</span><br><span class="line">    path &#x3D; &#x2F;var&#x2F;www&#x2F;staichtml&#x2F;</span><br><span class="line">    use chroot &#x3D; no</span><br><span class="line">    max connections&#x3D;20</span><br><span class="line">    lock file &#x3D; &#x2F;var&#x2F;lock&#x2F;rsyncd</span><br><span class="line">    read only &#x3D; no</span><br><span class="line">  write only &#x3D; no</span><br><span class="line">    list &#x3D; yes</span><br><span class="line">    uid &#x3D; rsync</span><br><span class="line">    gid &#x3D; rsync</span><br><span class="line">  auth users &#x3D; rsync_clint</span><br><span class="line">  secrets file &#x3D; &#x2F;etc&#x2F;rsyncd.secrets</span><br><span class="line">    strict modes &#x3D; yes</span><br><span class="line">  port&#x3D;873</span><br><span class="line">  pid file &#x3D; &#x2F;var&#x2F;run&#x2F;rsyncd.pid</span><br><span class="line">  log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log</span><br><span class="line">  log format &#x3D; %t %a %m %f %b</span><br><span class="line">    ignore errors &#x3D; yes</span><br><span class="line">    ignore nonreadable &#x3D; yes</span><br><span class="line">    transfer logging &#x3D; yes</span><br><span class="line">    timeout &#x3D; 600</span><br><span class="line">    refuse options &#x3D; checksum dry-run</span><br><span class="line">    dont compress &#x3D; *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>创建 /etc/rsyncd.secrets 并 chmod 600 权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync_clint:密码123</span><br></pre></td></tr></table></figure><p>添加一个系统用户为rsync的用户 <em>该用户不具备登录权限</em></p><pre><code>&lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;useradd -s &amp;#x2F;sbin&amp;#x2F;nologin -M rsync&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;</code></pre><p><strong>！！！注意！！！必须 chmod 777 /var/www/staichtml/ 在实际操作中发现没有x权限rsync服务无法写入文件</strong></p><h3 id="内网服务器配置"><a href="#内网服务器配置" class="headerlink" title="内网服务器配置"></a>内网服务器配置</h3><p><em>略过相关web服务配置</em><br>创建 /etc/rsyncd.secrets 并 chmod 600 权限，仅存放密码使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">密码123</span><br></pre></td></tr></table></figure><p>安装apt install inofity-tool</p><p>编写简单实现的.sh文件并 chmod +x xxxx.sh</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">src&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;mystaticsite&#x2F; #同步目录路径</span><br><span class="line">ip&#x3D;111.111.111.111</span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;inotifywait -rm  --timefmt &#39;%d&#x2F;%m&#x2F;%y %H:%M&#39; --format &#39;%T %w%f%e&#39; -e modify,delete,create,attrib,move $src | while read file</span><br><span class="line">   do</span><br><span class="line">     rsync -avz --delete --progress $src rsync_clint@$ip::123 --password-file&#x3D;&#x2F;etc&#x2F;rsyncd.secrets</span><br><span class="line">    echo &quot;$&#123;file&#125; was rsynced&quot; &gt;&gt; &#x2F;tmp&#x2F;rsync.log 2&gt;&amp;1</span><br><span class="line">   done</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">！！！注意！！！</span><br><span class="line">必须将$src的位置写在连接之前不能放在连接之后，不然外网服务器无法接受到文件。</span><br><span class="line">这一点与网上很多教程向左，卡了我两天多的时间才发现的:(</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;设计要求&quot;&gt;&lt;a href=&quot;#设计要求&quot; class=&quot;headerlink&quot; title=&quot;设计要求&quot;&gt;&lt;/a&gt;设计要求&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;内网web服务器生成html页面&lt;/li&gt;
&lt;li&gt;内网向外网同步生成的html页面和目录&lt;/li&gt;
&lt;li&gt;外
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>rsync同步基本配置（基础知识）</title>
    <link href="http://yoursite.com/2020/08/03/rsync%E5%90%8C%E6%AD%A5%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%EF%BC%88%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%89/"/>
    <id>http://yoursite.com/2020/08/03/rsync%E5%90%8C%E6%AD%A5%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%EF%BC%88%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%89/</id>
    <published>2020-08-03T02:04:38.000Z</published>
    <updated>2020-08-03T02:57:07.095Z</updated>
    
    <content type="html"><![CDATA[<h2 id="rrsync同步基本配置（基础知识）"><a href="#rrsync同步基本配置（基础知识）" class="headerlink" title="rrsync同步基本配置（基础知识）"></a>rrsync同步基本配置（基础知识）</h2><h3 id="Ubuntu-20-x-环境"><a href="#Ubuntu-20-x-环境" class="headerlink" title="Ubuntu 20.x 环境"></a>Ubuntu 20.x 环境</h3><h3 id="服务器端："><a href="#服务器端：" class="headerlink" title="服务器端："></a>服务器端：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[123]</span><br><span class="line"> comment &#x3D; 123 static html files server</span><br><span class="line">path &#x3D; &#x2F;var&#x2F;www&#x2F;html&#x2F;site</span><br><span class="line">use chroot &#x3D; no</span><br><span class="line">max connections&#x3D;20</span><br><span class="line">lock file &#x3D; &#x2F;var&#x2F;lock&#x2F;rsyncd</span><br><span class="line">read only &#x3D; yes</span><br><span class="line">list &#x3D; yes</span><br><span class="line">uid &#x3D; 0</span><br><span class="line">gid &#x3D; 0</span><br><span class="line">     auth users &#x3D; 123clint</span><br><span class="line">     secrets file &#x3D; &#x2F;etc&#x2F;rsyncd.secrets</span><br><span class="line">     strict modes &#x3D; yes</span><br><span class="line">     port&#x3D;873</span><br><span class="line">ignore errors &#x3D; yes</span><br><span class="line">ignore nonreadable &#x3D; yes</span><br><span class="line">transfer logging &#x3D; yes</span><br><span class="line">timeout &#x3D; 600</span><br><span class="line">refuse options &#x3D; checksum dry-run</span><br><span class="line">dont compress &#x3D; *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz</span><br></pre></td></tr></table></figure><p>增加/etc/rsyncd.secrets文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123clint：密码123456</span><br></pre></td></tr></table></figure><p>启动服务器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;rsync --daemon</span><br></pre></td></tr></table></figure><h3 id="客户端："><a href="#客户端：" class="headerlink" title="客户端："></a>客户端：</h3><p>增加/etc/rsyncd.secrets文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">密码123456</span><br></pre></td></tr></table></figure><p>客户端连接服务器命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -vzrtopg --delete --progress 123clint@服务器地址::123 &#x2F;var&#x2F;www&#x2F;staichtml（客户端备份目录位置） --password-file&#x3D;&#x2F;etc&#x2F;rsyncd.secrets</span><br></pre></td></tr></table></figure><p> <strong>注意</strong><br>客户端和服务器端的rsyncd.secrets 文件均需要chmod 600 权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 rsyncd.secrets </span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;rrsync同步基本配置（基础知识）&quot;&gt;&lt;a href=&quot;#rrsync同步基本配置（基础知识）&quot; class=&quot;headerlink&quot; title=&quot;rrsync同步基本配置（基础知识）&quot;&gt;&lt;/a&gt;rrsync同步基本配置（基础知识）&lt;/h2&gt;&lt;h3 id=&quot;U
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
